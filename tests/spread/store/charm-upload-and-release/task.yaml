summary: full charm cycle -- pack, upload, check revisions, release, check channel map

include: 
  - tests/

prepare: |
  tests.pkgs install jq
  charmcraft init --project-dir=charm --name=$CHARM_DEFAULT_NAME --profile=machine
  cd charm

restore: |
  pushd charm
  charmcraft clean
  popd
  
  rm -rf charm

execute: |
  cd charm
  start_datetime=$(date -u --iso-8601=seconds)

  # pack
  charmcraft pack --verbose
  test -f $CHARM_DEFAULT_NAME*.charm
  charm_filepath=$(ls $CHARM_DEFAULT_NAME*.charm)

  # upload
  charmcraft upload $charm_filepath

  # check that latest revision is newer than start datetime
  last_revision=$(charmcraft revisions $CHARM_DEFAULT_NAME --format=json | jq -r .[0])
  last_revision_created=$(echo $last_revision | jq -r .created_at)
  [[ $start_datetime < $last_revision_created ]]

  # release that last revision to edge
  last_revision_revno=$(echo $last_revision | jq -r .revision)
  charmcraft release $CHARM_DEFAULT_NAME -r $last_revision_revno -c edge

  # validate the channel map
  edge_release=$(charmcraft status $CHARM_DEFAULT_NAME --format=json | jq -r '.[] | select(.track=="latest") | .mappings[0].releases | .[] | select(.channel=="latest/edge")')
  edge_revision=$(echo $edge_release | jq -r .revision)
  test $edge_revision == $last_revision_revno
